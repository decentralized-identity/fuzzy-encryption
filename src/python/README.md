# Fuzzy Encryption for Secret Recovery
<br/>

**WARNING: This implementation is for prototype and testing purposes only. DO NOT use in production, as this implementation WILL NOT be supported. Another implmentation of the Fuzzy Encryption scheme (written in C++) is under active development and will offer long-term production support after publication to this repository.**

**WARNING: This code relies on copyleft dependencies which may require special attention to use safely within commercial products. Please be take care to ensure you are abiding by the license terms specified in these dependencies.**

Fuzzy Encryption for Secret Recovery project is an approach to provide an alternative for unmemorable user-controlled cryptographic keys composed of secret long strings of random numbers and letters. Our project presents a scheme where a user is expected to remember/securely protect a pass-phrase alone. This pass-phrase is used to generate cryptographic key material that is used to generate as well as recover cryptographic key(s). Any state information generated by the scheme in order to generate the cryptographic key material from the pass-phrase can be stored in any public repository. However, once in the public repository it cannot be modified, otherwise secret can no longer be recovered.

## Table of Contents

- [Installation](#installation)
    - [Clone](#clone)
    - [Setup](#setup)
- [Documentation](#documentation)
  - [Understanding the code...](#understanding-the-code)
    - [InputParams (Class):](#inputparams-class)
    - [FuzzyState (Class):](#fuzzystate-class)
    - [GenerateSecret (Function):](#generatesecret-function)
    - [RecoverSecret (Function):](#recoversecret-function)
  - [Tests and Demos](#tests-and-demos)
- [Dependencies](#dependencies)

---

## Installation

*System Compatibility: Linux (Ubuntu or Debian distros) or Windows using Windows Subsystem for Linux  (WSL2).*

You will need to clone this repo to your local machine. If you don't have git installed, you can simply do so by typing the following in command line (update the package index first):

```shell
$ sudo apt update 
$ sudo apt install git
```

#### Clone and Setup

Clone this repo to your local machine.
<br/>
Next, in order to install all needed dependencies before running or testing this program, you will need to run the bash script [install.sh](./install.sh).
If you're currently in the local directory where it resides, type the following in command line, otherwise replace with the correct PATH to [install.sh](./install.sh):

```bash
$ ./install.sh
```

If you receive the  <span style="color:red">error</span> below: 

**-bash: ./install.sh: Permission denied**

then you will need to change mode first, type the following in command line before retrying the previous step:

```bash
$ chmod +x ./install.sh
```
*Provide password for root access if asked, give permission for memory space usage and wait for the installations to complete, please note that this might take a while...*

---
## Documentation

### Understanding the code...
*We'll discuss some of the main classes and functions used in [fuzzy.py](./fuzzy.py) to generate and recover cryptographic keys using the user's pass-phrase.*

#### InputParams (Class):
This class intializes all input parameters used by `GenerateSecret()`, these parameters are:
1. `setSize`: this is the number of words required for establishing the intial secret and for recovering the secret. *This is specfied by the user.*
2. `correctThreshold`: this is the minumum number of words that must be correctly guessed in order to successfully recover the secret. This must be greater than half of the number of words (`setSize`). *This is specified by the user.*
3. `corpusSize`: This is the size of the set of allowed words. This means that both the origial words and recovery words must be represented by integers in the range 0 .. (`corpusSize` - 1). *This is specified by the user.*
4. `prime`: This a prime number (p) such that `setSize` < p < 2 * `setSize`. *The user does not set this number*, instead it is derived from the `corpusSize` which is specfied by the user.
5. `salt`: bytes required for slowing down brue force attacks. Created by the constructor. This value is not specified by the user.
6. `extractor`: bytes required of key genertion. Automatically generated by the constructor. *This value is not specified by the user.*

*Note that once these parameters are set, they will not be altered again for that code run, meaning they will be globally constant throughout the code.*

#### FuzzyState (Class):

The state is retained for recovering keys, this is what is sometimes refered to as the "payload". It's created at the time of the call to `GenerateSecret()`. It's up to the caller to save this information in the form of a JSON file. This is easy to do since the string represenation of this object, as returned by `__repr__()`, is a string containing the JSON representation. This information is required by `RecoverSecret()`.

#### GenerateSecret (Function):
`GenerateSecret()` establishes the original words of the vault. In addition, it returns a state and a list of 512-bit keys. The state contains the information needed to recover the keys with `RecoverSecret()`.

*Return Output:*
1. `FuzzyState` object.
2. A list of `key_count` 512-bit keys.

*Input:*
1. `params`: This is an object of the class `InputParams` that contains the necessary input.
2. `original_words`: A list of unique of integers in the range 0 .. (`corpusSize` - 1) representing the secret words needed to recover the keys.
3. `key_count`: The initial number of keys requested.

#### RecoverSecret (Function):
`RecoverSecret()` recovers a `key_count` list of keys. 

*Return Output:*

1. A list of keys if successful. Otherwise, it throws a `FuzzyError exception` if the keys cannot be recovered.

*Input:*
1. `state`: The FuzzyState created by GenerateSecret.
2. `recovery_words`: A guess of the original words. These are unique integers in the range 0 .. `corpusSize` - 1.
3. `key_count`: The number of keys to be generated.

---
### Tests and Demos 
<br/>
After installing the necessary prerequisites and getting familiar with the code, we've provided a tutorial you can use to test and demo our scheme...

First, you will need to need to change your directory to the right PATH where the python files are located, as such:

```shell
$ cd PATH/
```
After that, you can start your demo by setting the parameters for generating your cryptographic key:

```shell
$ python3 gen_params.py
``` 
You can also add an option to set the path to another JSON file to hold the generated input parameters (default= `params.json`):

 ```shell
$ python3 gen_params.py --params-path TEXT
``` 
Specify your parameters (for the purpose of this tutorial, we will use the following example):
```
set size: 9
correct threshold: 7
corpus size: 7000
writing parameters to params.json
``` 
If you'd like to review the parameters you've set, you can simply open `params.json` (by default):
```shell
$ cat params.json
``` 
Output for our example:
```
{
  "setSize": 9,
  "corpusSize": 7000,
  "correctThreshold": 7,
  "prime": 7001,
  "extractor": [
    2771,
    3429,
    1060,
    4146,
    3277,
    4753,
    4128,
    3279,
    6433
  ],
  "salt": "8C0565D57684E3F8B24829392A17C0956EADB4275ABFABF615C35909CE1D9732"
}
``` 
Since we have our input parameters set, we can generate the cryptographic key, you can do so by typing the following in command line:
```shell
$ python3 gen_secret.py
```
Now you can choose your pass-phrase, make sure it has the same number of words as your `setSize` parameter, and that each word is unique and within the `corpus_size`. Note that we are using integers and not strings, but it's up to the developer to include a word-to-integer mapping function before utilizing our tool, for this example, we'll use the following pass-phrase:
```
words: 11 2 30 44 65 89 99 110 20
```
Output:
```
keys:
- E8FF101BD69E2A252AA9E4721633BE0F52F9AEA88505F070747909A08FF76BC1A96CAA79C9C1496C9DF809B3E4B943A21D5E3DEF67F7BCB175824B8881A29CEC

writing secret to secret.json
```
If you'd like to generate more than one key, you can include the option for `key-count` as follows:
```shell
$ python3 gen_secret.py --key-count 4

words: 11 2 30 44 65 89 99 110 20

keys:
- E8FF101BD69E2A252AA9E4721633BE0F52F9AEA88505F070747909A08FF76BC1A96CAA79C9C1496C9DF809B3E4B943A21D5E3DEF67F7BCB175824B8881A29CEC
- 203051F9838EBB2BD862197DFAFCBBBC43A87B217A08D9E5224D4E27254BAD1276F5F29A4F390B4E2ED92D00EC86BC4C92E00E302F30D4D70684F5C44D7BCABC
- 1A7EE895C1F0B88C06A03CD6258825DF2B92FD2F311F894345AAC6CDC970EE7CFBDDE2582BAFF83D2DE646A66D5E40393407F8E1456F3FE089B54EAB4F741CBE
- 24C3C940B7F41E9792D3EA8D3D8675F84589B2494D9E856A5E0C4D8C28787B0F35D1329FCC8743E1FE79829AFA750A5F95538B153987B215D1C33692F8C11EC2

writing secret to secret.json
```
Now that we have our key, we might want to recover it, we can easily do so with the chosen pass-phrase or a *close enough* guess:
```shell
$ python3 rec_secret.py
```
For our example, the following inputs will all <span style="color:red">fail</span>:
```python
words: 11 2 30 44 65 89 99 110 #The number of words doesn't match the setSize, regardless of how many words are correct
words: 11 2 30 44 65 89 9 11 2 #Includes only 6 correct words and we need at least 7 correct words since the correctThreshold is 7.
```
If we input the correct pass-phrase or a guess within the correctThreshold, we can retrieve the key(s), here we use 8 correct words which is allowed:
```
words: 11 2 30 44 65 89 99 110 5 

keys:
- E8FF101BD69E2A252AA9E4721633BE0F52F9AEA88505F070747909A08FF76BC1A96CAA79C9C1496C9DF809B3E4B943A21D5E3DEF67F7BCB175824B8881A29CEC
```

---
## Dependencies 
<br/>

Python packages needed to run `Fuzzy-KeyRecovery`'s code:

| Package      | Version   |   
|------------- | --------- |
| flint-py     | 0.3.5     |
| crypto       | 1.4.1     |
| pyOpenSSL    | 19.1.0    |
| click        | 7.1.2     |
| jsonschema   | 3.2.0     |
| sympy        | 1.6.2     |
| hashids      | 1.3.1     |
| scrypt       | 0.8.17    |
